name: Run Tests

on:
  workflow_call:

jobs:
  test-detector:
    name: Test PII Detector Service
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install dependencies
        run: |
          cd pii-detector-service
          pip install --upgrade pip
          pip install -e ".[test]"
        env:
          PYTHONPATH: ${{ github.workspace }}/pii-detector-service
          PIP_EXTRA_INDEX_URL: https://download.pytorch.org/whl/cpu

      - name: Generate protobuf files
        run: |
          cd pii-detector-service
          python pii_detector/proto/generate_pb.py

      - name: Run unit tests
        run: |
          cd pii-detector-service
          python -m pytest tests/unit/ -v --tb=short --cov=pii_detector --cov-report=xml --cov-report=term-missing
        env:
          PYTHONPATH: ${{ github.workspace }}/pii-detector-service

      - name: Upload coverage reports
        uses: codecov/codecov-action@v4
        if: always()
        with:
          files: ./pii-detector-service/coverage.xml
          flags: detector
          name: detector-coverage
          fail_ci_if_error: false

  test-api:
    name: Test Reporting API
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 25
        uses: actions/setup-java@v4
        with:
          java-version: '25'
          distribution: 'temurin'
          cache: 'maven'

      - name: Run tests with Maven
        run: |
          cd pii-reporting-api
          mvn clean test -Pci-build
        env:
          MAVEN_OPTS: '-Xmx1024m'

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: api-test-results
          path: pii-reporting-api/target/surefire-reports/

  test-ui:
    name: Test Reporting UI (Angular Jest)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.x'
          cache: 'npm'
          cache-dependency-path: pii-reporting-ui/package-lock.json

      - name: Install dependencies
        run: |
          cd pii-reporting-ui
          npm ci

      - name: Run Jest tests with coverage
        run: |
          cd pii-reporting-ui
          npm run test:coverage

      - name: Upload coverage reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ui-test-coverage
          path: pii-reporting-ui/coverage/jest/

  tests-status:
    name: Tests Status Check
    runs-on: ubuntu-latest
    needs: [test-detector, test-api, test-ui]
    if: always()
    steps:
      - name: Check tests results
        run: |
          if [ "${{ needs.test-detector.result }}" != "success" ] || \
             [ "${{ needs.test-api.result }}" != "success" ] || \
             [ "${{ needs.test-ui.result }}" != "success" ]; then
            echo "❌ At least one test job failed"
            echo "Detector: ${{ needs.test-detector.result }}"
            echo "API: ${{ needs.test-api.result }}"
            echo "UI: ${{ needs.test-ui.result }}"
            exit 1
          fi
          echo "✅ All tests passed successfully"
