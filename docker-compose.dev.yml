services:
  # ============================================================================
  # BOOTSTRAP SECRETS (one-shot) - DEV
  # Creates ./secrets and generates the secrets required for Infisical on first startup
  # Mirrors production behavior but writes DEV client placeholders:
  # - infisical_dev_client_id.txt
  # - infisical_dev_client_secret.txt
  # - infisical_project_id.txt
  # ============================================================================
  secrets-bootstrap:
    image: alpine:3.20
    container_name: ai-sentinel-secrets-bootstrap-dev
    restart: "no"
    command: >
      sh -c '
        set -eu;

        echo "[secrets-bootstrap-dev] Starting secrets initialization...";
        mkdir -p /secrets;

        # Core secrets (shared)
        if [ ! -f /secrets/infisical_encryption_key.txt ] || [ "$(wc -c < /secrets/infisical_encryption_key.txt 2>/dev/null || echo 0)" -ne 32 ]; then
          od -An -tx1 -N16 /dev/urandom | tr -d " \n" > /secrets/infisical_encryption_key.txt;
        fi;
        if [ ! -f /secrets/infisical_auth_secret.txt ] || [ "$(wc -c < /secrets/infisical_auth_secret.txt 2>/dev/null || echo 0)" -lt 44 ]; then
          head -c 32 /dev/urandom | base64 | tr -d "\n\r" > /secrets/infisical_auth_secret.txt;
        fi;
        if [ ! -s /secrets/infisical_db_password.txt ]; then
          head -c 256 /dev/urandom | tr -dc "A-Za-z0-9" | head -c 24 > /secrets/infisical_db_password.txt;
        fi;
        if [ ! -f /secrets/pii_database_encryption_key.txt ] || [ "$(wc -c < /secrets/pii_database_encryption_key.txt 2>/dev/null || echo 0)" -lt 44 ]; then
          head -c 32 /dev/urandom | base64 | tr -d "\n\r" > /secrets/pii_database_encryption_key.txt;
        fi;
        if [ ! -s /secrets/postgres_user.txt ]; then
          echo "postgres" > /secrets/postgres_user.txt;
        fi;
        if [ ! -s /secrets/postgres_password.txt ]; then
          head -c 256 /dev/urandom | tr -dc "A-Za-z0-9" | head -c 24 > /secrets/postgres_password.txt;
        fi;

        # PGAdmin Credentials (used by infisical-configurator to seed Infisical secrets)
        if [ ! -s /secrets/pgadmin_email.txt ]; then
          echo "admin@ai-sentinel.local" > /secrets/pgadmin_email.txt;
        fi;
        if [ ! -s /secrets/pgadmin_password.txt ]; then
          head -c 256 /dev/urandom | tr -dc "A-Za-z0-9" | head -c 24 > /secrets/pgadmin_password.txt;
        fi;

        # Dev placeholders (must be filled by configurator or manually)
        [ -f /secrets/infisical_dev_client_id.txt ] || touch /secrets/infisical_dev_client_id.txt;
        [ -f /secrets/infisical_dev_client_secret.txt ] || touch /secrets/infisical_dev_client_secret.txt;
        [ -f /secrets/infisical_project_id.txt ] || touch /secrets/infisical_project_id.txt;

        echo "[secrets-bootstrap-dev] ✓ Secrets directory ready";
      '
    volumes:
      - ./secrets:/secrets
    networks:
      - ai-sentinel-network

  # ============================================================================
  # INFISICAL AUTO-CONFIGURATOR (one-shot) - DEV
  # Uses Infisical API to bootstrap admin + project + machine identity for DEV
  # and stores the Universal Auth credentials in ./secrets
  # ============================================================================
  infisical-configurator:
    image: alpine:3.20
    container_name: ai-sentinel-infisical-configurator-dev
    restart: "no"
    command: >
      sh -c '
        set -eu;

        apk add --no-cache curl jq > /dev/null 2>&1;

        INFISICAL_URL="http://infisical:8080";
        ADMIN_EMAIL="admin@ai-sentinel.local";

        ORG_NAME="AI Sentinel";
        PROJECT_NAME="AI Sentinel";
        ENV_NAME="dev";

        # Skip if already configured
        if [ -s /secrets/infisical_project_id.txt ] && [ -s /secrets/infisical_dev_client_id.txt ] && [ -s /secrets/infisical_dev_client_secret.txt ]; then
          echo "[infisical-config-dev] ✓ Already configured";
          exit 0;
        fi;

        echo "[infisical-config-dev] Waiting for Infisical API...";
        max_retries=30; retry=0;
        until curl -sf "$${INFISICAL_URL}/api/status" > /dev/null 2>&1; do
          retry=$$((retry + 1));
          if [ $$retry -ge $$max_retries ]; then
            echo "[ERROR] Infisical API not ready after $$max_retries attempts";
            exit 1;
          fi;
          sleep 2;
        done;

        # Generate random password (24 alphanumeric characters)
        ADMIN_PASSWORD=$$(head -c 256 /dev/urandom | tr -dc "A-Za-z0-9" | head -c 24);

        echo "[infisical-config-dev] ================================================";
        echo "[infisical-config-dev] Infisical DEV admin credentials (save these)";
        echo "[infisical-config-dev]   Email:    $${ADMIN_EMAIL}";
        echo "[infisical-config-dev]   Password: $${ADMIN_PASSWORD}";
        echo "[infisical-config-dev]   UI URL:   http://localhost:8082";
        echo "[infisical-config-dev] ================================================";

        # Bootstrap admin
        BOOTSTRAP_RESPONSE=$$(curl -s -w "\n%{http_code}" -X POST "$${INFISICAL_URL}/api/v1/admin/bootstrap" \
          -H "Content-Type: application/json" \
          -d "{\"email\":\"$${ADMIN_EMAIL}\",\"password\":\"$${ADMIN_PASSWORD}\",\"organization\":\"$${ORG_NAME}\"}");
        HTTP_CODE=$$(echo "$$BOOTSTRAP_RESPONSE" | tail -n1);
        BOOTSTRAP_BODY=$$(echo "$$BOOTSTRAP_RESPONSE" | head -n -1);
        if [ "$$HTTP_CODE" != "200" ]; then
          echo "[ERROR] Failed to bootstrap Infisical (HTTP $$HTTP_CODE)";
          echo "[ERROR] $$BOOTSTRAP_BODY";
          exit 1;
        fi;
        ADMIN_TOKEN=$$(echo "$$BOOTSTRAP_BODY" | jq -r ".identity.credentials.token");
        ORG_ID=$$(echo "$$BOOTSTRAP_BODY" | jq -r ".organization.id");
        if [ -z "$$ADMIN_TOKEN" ] || [ "$$ADMIN_TOKEN" = "null" ]; then
          echo "[ERROR] Missing admin token";
          exit 1;
        fi;

        # Create project
        PROJECT_RESPONSE=$$(curl -s -w "\n%{http_code}" -X POST "$${INFISICAL_URL}/api/v1/projects" \
          -H "Authorization: Bearer $${ADMIN_TOKEN}" \
          -H "Content-Type: application/json" \
          -d "{\"projectName\":\"$${PROJECT_NAME}\",\"projectDescription\":\"Auto-configured AI Sentinel project\",\"type\":\"secret-manager\",\"shouldCreateDefaultEnvs\":true}");
        HTTP_CODE=$$(echo "$$PROJECT_RESPONSE" | tail -n1);
        PROJECT_BODY=$$(echo "$$PROJECT_RESPONSE" | head -n -1);
        if [ "$$HTTP_CODE" != "200" ] && [ "$$HTTP_CODE" != "201" ]; then
          echo "[ERROR] Failed to create project (HTTP $$HTTP_CODE)";
          echo "[ERROR] $$PROJECT_BODY";
          exit 1;
        fi;
        PROJECT_ID=$$(echo "$$PROJECT_BODY" | jq -r ".project.id");
        echo "$$PROJECT_ID" > /secrets/infisical_project_id.txt;

        # Create machine identity
        IDENTITY_CREATE_RESPONSE=$$(curl -s -w "\n%{http_code}" -X POST "$${INFISICAL_URL}/api/v1/identities" \
          -H "Authorization: Bearer $${ADMIN_TOKEN}" \
          -H "Content-Type: application/json" \
          -d "{\"name\":\"ai-sentinel-$${ENV_NAME}\",\"organizationId\":\"$${ORG_ID}\",\"role\":\"admin\"}");
        HTTP_CODE=$$(echo "$$IDENTITY_CREATE_RESPONSE" | tail -n1);
        IDENTITY_CREATE_BODY=$$(echo "$$IDENTITY_CREATE_RESPONSE" | head -n -1);
        if [ "$$HTTP_CODE" != "200" ] && [ "$$HTTP_CODE" != "201" ]; then
          echo "[ERROR] Failed to create identity (HTTP $$HTTP_CODE)";
          echo "[ERROR] $$IDENTITY_CREATE_BODY";
          exit 1;
        fi;
        IDENTITY_ID=$$(echo "$$IDENTITY_CREATE_BODY" | jq -r ".identity.id");

        # Attach Universal Auth
        UNIVERSAL_AUTH_RESPONSE=$$(curl -s -w "\n%{http_code}" -X POST "$${INFISICAL_URL}/api/v1/auth/universal-auth/identities/$${IDENTITY_ID}" \
          -H "Authorization: Bearer $${ADMIN_TOKEN}" \
          -H "Content-Type: application/json" \
          -d "{\"accessTokenTTL\":2592000,\"accessTokenMaxTTL\":2592000,\"accessTokenNumUsesLimit\":0}");
        HTTP_CODE=$$(echo "$$UNIVERSAL_AUTH_RESPONSE" | tail -n1);
        UNIVERSAL_AUTH_BODY=$$(echo "$$UNIVERSAL_AUTH_RESPONSE" | head -n -1);
        if [ "$$HTTP_CODE" != "200" ] && [ "$$HTTP_CODE" != "201" ]; then
          echo "[ERROR] Failed to attach Universal Auth (HTTP $$HTTP_CODE)";
          echo "[ERROR] $$UNIVERSAL_AUTH_BODY";
          exit 1;
        fi;
        CLIENT_ID=$$(echo "$$UNIVERSAL_AUTH_BODY" | jq -r ".identityUniversalAuth.clientId");

        # Create client secret
        CLIENT_SECRET_RESPONSE=$$(curl -s -w "\n%{http_code}" -X POST "$${INFISICAL_URL}/api/v1/auth/universal-auth/identities/$${IDENTITY_ID}/client-secrets" \
          -H "Authorization: Bearer $${ADMIN_TOKEN}" \
          -H "Content-Type: application/json" \
          -d "{\"description\":\"Auto-generated for $${ENV_NAME}\",\"ttl\":0,\"numUsesLimit\":0}");
        HTTP_CODE=$$(echo "$$CLIENT_SECRET_RESPONSE" | tail -n1);
        CLIENT_SECRET_BODY=$$(echo "$$CLIENT_SECRET_RESPONSE" | head -n -1);
        if [ "$$HTTP_CODE" != "200" ] && [ "$$HTTP_CODE" != "201" ]; then
          echo "[ERROR] Failed to create client secret (HTTP $$HTTP_CODE)";
          echo "[ERROR] $$CLIENT_SECRET_BODY";
          exit 1;
        fi;
        CLIENT_SECRET=$$(echo "$$CLIENT_SECRET_BODY" | jq -r ".clientSecret");

        # Add machine identity to project/workspace (required so universal-auth token can access secrets)
        ADD_TO_PROJECT_RESPONSE=$$(curl -s -w "\n%{http_code}" -X POST "$${INFISICAL_URL}/api/v2/workspace/$${PROJECT_ID}/identity-memberships/$${IDENTITY_ID}" \
          -H "Authorization: Bearer $${ADMIN_TOKEN}" \
          -H "Content-Type: application/json" \
          -d "{\"role\":\"admin\"}");
        HTTP_CODE=$$(echo "$$ADD_TO_PROJECT_RESPONSE" | tail -n1);
        ADD_TO_PROJECT_BODY=$$(echo "$$ADD_TO_PROJECT_RESPONSE" | head -n -1);
        if [ "$$HTTP_CODE" != "200" ] && [ "$$HTTP_CODE" != "201" ]; then
          echo "[ERROR] Failed to add identity to project/workspace (HTTP $$HTTP_CODE)";
          echo "[ERROR] $$ADD_TO_PROJECT_BODY";
          exit 1;
        fi;

        echo "$$CLIENT_ID" > /secrets/infisical_dev_client_id.txt;
        echo "$$CLIENT_SECRET" > /secrets/infisical_dev_client_secret.txt;

        # Validate universal-auth credentials can actually read secrets (prevents silent 403 later)
        echo "[infisical-config-dev] Validating machine identity access...";
        UA_LOGIN_RESPONSE=$$(curl -s -w "\n%{http_code}" -X POST "$${INFISICAL_URL}/api/v1/auth/universal-auth/login" \
          -H "Content-Type: application/json" \
          -d "{\"clientId\":\"$${CLIENT_ID}\",\"clientSecret\":\"$${CLIENT_SECRET}\"}");
        UA_LOGIN_HTTP=$$(echo "$$UA_LOGIN_RESPONSE" | tail -n1);
        UA_LOGIN_BODY=$$(echo "$$UA_LOGIN_RESPONSE" | head -n -1);
        if [ "$$UA_LOGIN_HTTP" != "200" ]; then
          echo "[ERROR] Universal auth login failed during validation (HTTP $$UA_LOGIN_HTTP)";
          echo "[ERROR] $$UA_LOGIN_BODY";
          exit 1;
        fi;
        UA_ACCESS_TOKEN=$$(echo "$$UA_LOGIN_BODY" | jq -r ".accessToken");
        if [ -z "$$UA_ACCESS_TOKEN" ] || [ "$$UA_ACCESS_TOKEN" = "null" ]; then
          echo "[ERROR] Missing accessToken in universal-auth login response";
          echo "[ERROR] $$UA_LOGIN_BODY";
          exit 1;
        fi;

        # Attempt to fetch secrets with the machine token. Any 403 here means identity membership/permissions are wrong.
        SECRETS_VALIDATE_RESPONSE=$$(curl -s -w "\n%{http_code}" "$${INFISICAL_URL}/api/v3/secrets/raw?environment=$${ENV_NAME}&expandSecretReferences=true&include_imports=true&secretPath=%2F&workspaceId=$${PROJECT_ID}" \
          -H "Authorization: Bearer $${UA_ACCESS_TOKEN}");
        SECRETS_VALIDATE_HTTP=$$(echo "$$SECRETS_VALIDATE_RESPONSE" | tail -n1);
        SECRETS_VALIDATE_BODY=$$(echo "$$SECRETS_VALIDATE_RESPONSE" | head -n -1);
        if [ "$$SECRETS_VALIDATE_HTTP" != "200" ]; then
          echo "[ERROR] Machine identity cannot read secrets (HTTP $$SECRETS_VALIDATE_HTTP)";
          echo "[ERROR] $$SECRETS_VALIDATE_BODY";
          exit 1;
        fi;

        # Create required secrets in project for DEV
        echo "[infisical-config-dev] Seeding required secrets in Infisical (env=$${ENV_NAME})...";

        DB_USER=$$(cat /secrets/postgres_user.txt);
        curl -sf -X POST "$${INFISICAL_URL}/api/v4/secrets/DB_USER" \
          -H "Authorization: Bearer $${ADMIN_TOKEN}" \
          -H "Content-Type: application/json" \
          -d "{\"projectId\":\"$${PROJECT_ID}\",\"environment\":\"$${ENV_NAME}\",\"secretPath\":\"/\",\"secretValue\":\"$${DB_USER}\",\"secretComment\":\"Auto-generated PostgreSQL username\",\"type\":\"shared\"}" \
          > /dev/null 2>&1 && echo "[infisical-config-dev]   ✓ DB_USER created" || echo "[infisical-config-dev]   ⚠ DB_USER may already exist";

        DB_PASSWORD=$$(cat /secrets/postgres_password.txt);
        curl -sf -X POST "$${INFISICAL_URL}/api/v4/secrets/DB_PASSWORD" \
          -H "Authorization: Bearer $${ADMIN_TOKEN}" \
          -H "Content-Type: application/json" \
          -d "{\"projectId\":\"$${PROJECT_ID}\",\"environment\":\"$${ENV_NAME}\",\"secretPath\":\"/\",\"secretValue\":\"$${DB_PASSWORD}\",\"secretComment\":\"Auto-generated PostgreSQL password\",\"type\":\"shared\"}" \
          > /dev/null 2>&1 && echo "[infisical-config-dev]   ✓ DB_PASSWORD created" || echo "[infisical-config-dev]   ⚠ DB_PASSWORD may already exist";

        PGADMIN_EMAIL=$$(cat /secrets/pgadmin_email.txt);
        curl -sf -X POST "$${INFISICAL_URL}/api/v4/secrets/PGADMIN_DEFAULT_EMAIL" \
          -H "Authorization: Bearer $${ADMIN_TOKEN}" \
          -H "Content-Type: application/json" \
          -d "{\"projectId\":\"$${PROJECT_ID}\",\"environment\":\"$${ENV_NAME}\",\"secretPath\":\"/\",\"secretValue\":\"$${PGADMIN_EMAIL}\",\"secretComment\":\"Auto-generated PGAdmin email\",\"type\":\"shared\"}" \
          > /dev/null 2>&1 && echo "[infisical-config-dev]   ✓ PGADMIN_DEFAULT_EMAIL created" || echo "[infisical-config-dev]   ⚠ PGADMIN_DEFAULT_EMAIL may already exist";

        PGADMIN_PASSWORD=$$(cat /secrets/pgadmin_password.txt);
        curl -sf -X POST "$${INFISICAL_URL}/api/v4/secrets/PGADMIN_DEFAULT_PASSWORD" \
          -H "Authorization: Bearer $${ADMIN_TOKEN}" \
          -H "Content-Type: application/json" \
          -d "{\"projectId\":\"$${PROJECT_ID}\",\"environment\":\"$${ENV_NAME}\",\"secretPath\":\"/\",\"secretValue\":\"$${PGADMIN_PASSWORD}\",\"secretComment\":\"Auto-generated PGAdmin password\",\"type\":\"shared\"}" \
          > /dev/null 2>&1 && echo "[infisical-config-dev]   ✓ PGADMIN_DEFAULT_PASSWORD created" || echo "[infisical-config-dev]   ⚠ PGADMIN_DEFAULT_PASSWORD may already exist";

        # Create or update PII_DATABASE_ENCRYPTION_KEY idempotently
        PII_DATABASE_ENCRYPTION_KEY=$$(cat /secrets/pii_database_encryption_key.txt);
        HTTP_CODE=$$(curl -s -o /dev/null -w "%{http_code}" -X POST "$${INFISICAL_URL}/api/v4/secrets/PII_DATABASE_ENCRYPTION_KEY" \
          -H "Authorization: Bearer $${ADMIN_TOKEN}" \
          -H "Content-Type: application/json" \
          -d "{\"projectId\":\"$${PROJECT_ID}\",\"environment\":\"$${ENV_NAME}\",\"secretPath\":\"/\",\"secretValue\":\"$${PII_DATABASE_ENCRYPTION_KEY}\",\"secretComment\":\"Auto-generated AES-256 encryption key for PII database (32 bytes base64-encoded)\",\"type\":\"shared\"}");

        if [ "$$HTTP_CODE" = "200" ] || [ "$$HTTP_CODE" = "201" ]; then
          echo "[infisical-config-dev]   ✓ PII_DATABASE_ENCRYPTION_KEY created";
        elif [ "$$HTTP_CODE" = "409" ]; then
          HTTP_CODE_PUT=$$(curl -s -o /dev/null -w "%{http_code}" -X PUT "$${INFISICAL_URL}/api/v4/secrets/PII_DATABASE_ENCRYPTION_KEY" \
            -H "Authorization: Bearer $${ADMIN_TOKEN}" \
            -H "Content-Type: application/json" \
            -d "{\"projectId\":\"$${PROJECT_ID}\",\"environment\":\"$${ENV_NAME}\",\"secretPath\":\"/\",\"secretValue\":\"$${PII_DATABASE_ENCRYPTION_KEY}\",\"type\":\"shared\"}");
          if [ "$$HTTP_CODE_PUT" = "200" ]; then
            echo "[infisical-config-dev]   ✓ PII_DATABASE_ENCRYPTION_KEY updated";
          else
            echo "[infisical-config-dev]   ⚠ PII_DATABASE_ENCRYPTION_KEY exists but update returned HTTP $$HTTP_CODE_PUT; continuing";
          fi;
        else
          echo "[infisical-config-dev]   ⚠ Failed to create PII_DATABASE_ENCRYPTION_KEY (HTTP $$HTTP_CODE); continuing";
        fi;

        # Create empty secrets (to be filled manually)
        for secret_name in "HUGGING_FACE_API_KEY" "CONFLUENCE_BASE_URL" "CONFLUENCE_USERNAME" "CONFLUENCE_API_TOKEN"; do
          curl -sf -X POST "$${INFISICAL_URL}/api/v4/secrets/$$secret_name" \
            -H "Authorization: Bearer $${ADMIN_TOKEN}" \
            -H "Content-Type: application/json" \
            -d "{\"projectId\":\"$${PROJECT_ID}\",\"environment\":\"$${ENV_NAME}\",\"secretPath\":\"/\",\"secretValue\":\"\",\"secretComment\":\"Created empty - must be filled manually with real value\",\"type\":\"shared\"}" \
            > /dev/null 2>&1 && echo "[infisical-config-dev]   ✓ $$secret_name created (empty)" || echo "[infisical-config-dev]   ⚠ $$secret_name may already exist";
        done;

        echo "[infisical-config-dev] ✓ Config complete";
      '
    volumes:
      - ./secrets:/secrets
    depends_on:
      infisical:
        condition: service_healthy
      secrets-bootstrap:
        condition: service_completed_successfully
    networks:
      - ai-sentinel-network

  # ============================================================================
  # DATABASE SERVICE - DEV
  # Mirrors prod configuration but publishes Postgres to localhost:5433 for dev tools.
  # ============================================================================
  postgres:
    image: postgres:18
    container_name: ai-sentinel-db-dev
    restart: unless-stopped
    environment:
      POSTGRES_DB: ai-sentinel
    command: >
      sh -c '
        export POSTGRES_USER=$$(cat /secrets/postgres_user.txt) &&
        export POSTGRES_PASSWORD=$$(cat /secrets/postgres_password.txt) &&
        exec docker-entrypoint.sh postgres
      '
    ports:
      - "127.0.0.1:5433:5432"
    volumes:
      - postgres-data:/var/lib/postgresql
      - ./pii-reporting-api/init-scripts:/docker-entrypoint-initdb.d
      - ./secrets:/secrets:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $$(cat /secrets/postgres_user.txt) -d ai-sentinel"]
      interval: 10s
      timeout: 5s
      retries: 5
    depends_on:
      secrets-bootstrap:
        condition: service_completed_successfully
    networks:
      - ai-sentinel-network

  # ============================================================================
  # PII DETECTOR SERVICE (Python/gRPC)
  # ============================================================================
  pii-detector:
    build:
      context: .
      dockerfile: pii-detector-service/Dockerfile
    container_name: pii-detector-service
    restart: unless-stopped
    
    # Resource limits for stability (prevents OOM and limits CPU usage)
    deploy:
      resources:
        limits:
          cpus: '4.0'      # Max 4 CPU cores (adjust based on host)
          memory: 8G       # Max 8GB RAM for NLP/ML models
        reservations:
          cpus: '2.0'      # Guaranteed 2 CPU cores
          memory: 4G       # Guaranteed 4GB RAM
    
    ports:
      - "50051:50051"
    environment:
      # Infisical Configuration - secrets will be read from /secrets/
      INFISICAL_CLIENT_ID_FILE: /secrets/infisical_dev_client_id.txt
      INFISICAL_CLIENT_SECRET_FILE: /secrets/infisical_dev_client_secret.txt
      INFISICAL_PROJECT_ID_FILE: /secrets/infisical_project_id.txt
      INFISICAL_API_URL: http://infisical:8080
      INFISICAL_ENV: dev
      
      # Database Configuration for dynamic config fetch
      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: ai-sentinel
      
      # Static non-sensitive configuration
      HF_HOME: /app/.cache/huggingface
      TRANSFORMERS_CACHE: /app/.cache/huggingface
    volumes:
      - huggingface-cache:/app/.cache/huggingface
      - ./secrets:/secrets:ro
    depends_on:
      postgres:
        condition: service_healthy
      infisical-configurator:
        condition: service_completed_successfully
      infisical:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "python -c 'import grpc; channel = grpc.insecure_channel(\"localhost:50051\"); channel.close()'"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    networks:
      - ai-sentinel-network

  # ============================================================================
  # PII REPORTING API (Spring Boot)
  # ============================================================================
  pii-reporting-api:
    build:
      context: .
      dockerfile: pii-reporting-api/Dockerfile
    container_name: pii-reporting-api
    restart: unless-stopped
    ports:
      - "8080:8080"
      - "8090:8090"  # Armeria internal services (health, metrics, docs)
    environment:
      # Infisical Configuration - secrets will be read from /secrets/
      INFISICAL_CLIENT_ID_FILE: /secrets/infisical_dev_client_id.txt
      INFISICAL_CLIENT_SECRET_FILE: /secrets/infisical_dev_client_secret.txt
      INFISICAL_PROJECT_ID_FILE: /secrets/infisical_project_id.txt
      INFISICAL_API_URL: http://infisical:8080
      INFISICAL_ENV: dev
      
      # Static non-sensitive configuration
      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: ai-sentinel
      SERVER_PORT: 8080
      PII_DETECTOR_CLIENT: armeria
      PII_DETECTOR_HOST: pii-detector
      PII_DETECTOR_PORT: 50051
      
      # Non-sensitive Confluence configuration (optional with defaults)
      CONFLUENCE_ENABLE_PROXY: ${CONFLUENCE_ENABLE_PROXY:-false}
      CONFLUENCE_PROXY_HOST: ${CONFLUENCE_PROXY_HOST:-}
      CONFLUENCE_PROXY_PORT: ${CONFLUENCE_PROXY_PORT:-8080}
      CONFLUENCE_PROXY_USERNAME: ${CONFLUENCE_PROXY_USERNAME:-}
      CONFLUENCE_CACHE_REFRESH_INTERVAL: ${CONFLUENCE_CACHE_REFRESH_INTERVAL:-300000}
      CONFLUENCE_CACHE_INITIAL_DELAY: ${CONFLUENCE_CACHE_INITIAL_DELAY:-5000}
      CONFLUENCE_POLLING_INTERVAL: ${CONFLUENCE_POLLING_INTERVAL:-60000}
      PII_DATABASE_ENCRYPTION_KEY_FILE: /secrets/pii_database_encryption_key.txt
    volumes:
      - ./personally-identifiable-information-scan-results:/personally-identifiable-information-scan-results
      - ./secrets:/secrets:ro
    depends_on:
      postgres:
        condition: service_healthy
      pii-detector:
        condition: service_started
      infisical-configurator:
        condition: service_completed_successfully
      infisical:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/ai-sentinel/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    networks:
      - ai-sentinel-network

  # ============================================================================
  # PII REPORTING UI (Angular + Nginx)
  # ============================================================================
  pii-reporting-ui:
    build:
      context: ./pii-reporting-ui
      dockerfile: Dockerfile
    container_name: pii-reporting-ui
    restart: unless-stopped
    ports:
      - "4200:80"
    depends_on:
      pii-reporting-api:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:80 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - ai-sentinel-network

  # ============================================================================
  # PGADMIN (Optional - Database Management UI)
  # ============================================================================
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: pgadmin-sentinel
    restart: unless-stopped
    environment:
      PGADMIN_CONFIG_SERVER_MODE: 'False'
      PGADMIN_CONFIG_MASTER_PASSWORD_REQUIRED: 'False'
      # Infisical Configuration - secrets will be read from /secrets/
      INFISICAL_CLIENT_ID_FILE: /secrets/infisical_dev_client_id.txt
      INFISICAL_CLIENT_SECRET_FILE: /secrets/infisical_dev_client_secret.txt
      INFISICAL_PROJECT_ID_FILE: /secrets/infisical_project_id.txt
      INFISICAL_API_URL: http://infisical:8080
      INFISICAL_ENV: dev
    command: >
      sh -c '
        apk add --no-cache curl jq > /dev/null 2>&1;

        INFISICAL_CLIENT_ID=$$(cat /secrets/infisical_dev_client_id.txt);
        INFISICAL_CLIENT_SECRET=$$(cat /secrets/infisical_dev_client_secret.txt);
        INFISICAL_PROJECT_ID=$$(cat /secrets/infisical_project_id.txt);
        INFISICAL_API_URL="http://infisical:8080";

        echo "[pgadmin] Authenticating with Infisical...";
        TOKEN_RESPONSE=$$(curl -s -X POST "$$INFISICAL_API_URL/api/v1/auth/universal-auth/login" \
          -H "Content-Type: application/json" \
          -d "{\"clientId\":\"$$INFISICAL_CLIENT_ID\",\"clientSecret\":\"$$INFISICAL_CLIENT_SECRET\"}");

        ACCESS_TOKEN=$$(echo "$$TOKEN_RESPONSE" | jq -r ".accessToken");

        echo "[pgadmin] Fetching secrets from Infisical...";
        SECRETS_RESPONSE=$$(curl -s "$$INFISICAL_API_URL/api/v3/secrets/raw?workspaceId=$$INFISICAL_PROJECT_ID&environment=dev" \
          -H "Authorization: Bearer $$ACCESS_TOKEN");

        export PGADMIN_DEFAULT_EMAIL=$$(echo "$$SECRETS_RESPONSE" | jq -r ".secrets[] | select(.secretKey==\"PGADMIN_DEFAULT_EMAIL\") | .secretValue");
        export PGADMIN_DEFAULT_PASSWORD=$$(echo "$$SECRETS_RESPONSE" | jq -r ".secrets[] | select(.secretKey==\"PGADMIN_DEFAULT_PASSWORD\") | .secretValue");

        echo "[pgadmin] Secrets loaded, starting PGAdmin...";
        exec /entrypoint.sh
      '
    ports:
      - "5050:80"
    volumes:
      - pgadmin-data:/var/lib/pgadmin
      - ./secrets:/secrets:ro
    depends_on:
      postgres:
        condition: service_healthy
      infisical-configurator:
        condition: service_completed_successfully
      infisical:
        condition: service_healthy
    networks:
      - ai-sentinel-network
    profiles:
      - admin

  # ============================================================================
  # INFISICAL (Secrets Manager - UI only for development)
  # ============================================================================
  infisical-db:
    image: postgres:18-alpine
    container_name: infisical-db-dev
    restart: unless-stopped
    environment:
      POSTGRES_USER: infisical
      POSTGRES_PASSWORD_FILE: /secrets/infisical_db_password.txt
      POSTGRES_DB: infisical
    volumes:
      - infisical-db-data:/var/lib/postgresql/data
      - ./secrets:/secrets:ro
    depends_on:
      secrets-bootstrap:
        condition: service_completed_successfully
    networks:
      - ai-sentinel-network

  infisical-redis:
    image: redis:7-alpine
    container_name: infisical-redis-dev
    restart: unless-stopped
    command: ["redis-server", "--appendonly", "yes"]
    volumes:
      - infisical-redis-data:/data
    networks:
      - ai-sentinel-network

  mailhog:
    image: mailhog/mailhog:latest
    container_name: mailhog
    restart: unless-stopped
    ports:
      # SMTP server is only needed inside Docker network; not exposed to host for security
      # - "127.0.0.1:1025:1025"  # Uncomment if you need to test SMTP from the host
      - "127.0.0.1:8025:8025"  # Web UI (localhost only)
    networks:
      - ai-sentinel-network

  infisical:
    image: infisical/infisical:v0.153.4
    container_name: infisical-dev
    restart: unless-stopped
    ports:
      - "8082:8080"  # Expose Infisical UI on localhost:8082
    environment:
      NODE_ENV: development
      REDIS_URL: redis://infisical-redis:6379
      SITE_URL: ${INFISICAL_SITE_URL:-http://localhost:8082}
      # SMTP Configuration (MailHog for local development)
      SMTP_HOST: mailhog
      SMTP_PORT: 1025
      SMTP_SECURE: "false"
      SMTP_FROM_ADDRESS: noreply@ai-sentinel.local
      SMTP_FROM_NAME: "AI Sentinel Infisical"
      SMTP_TLS_ENABLED: "false"
      SMTP_STARTTLS_ENABLED: "false"
      SMTP_IGNORE_TLS: "true"
    command: >
      sh -c '
        export ENCRYPTION_KEY=$$(cat /secrets/infisical_encryption_key.txt) &&
        export AUTH_SECRET=$$(cat /secrets/infisical_auth_secret.txt) &&
        export DB_CONNECTION_URI="postgres://infisical:$$(cat /secrets/infisical_db_password.txt)@infisical-db:5432/infisical" &&
        exec /usr/local/bin/docker-entrypoint.sh ./standalone-entrypoint.sh
      '
    depends_on:
      secrets-bootstrap:
        condition: service_completed_successfully
      infisical-db:
        condition: service_started
      infisical-redis:
        condition: service_started
      mailhog:
        condition: service_started
    volumes:
      - ./secrets:/secrets:ro
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/api/status"]
      interval: 10s
      timeout: 10s
      retries: 15
      start_period: 60s
    networks:
      - ai-sentinel-network

volumes:
  postgres-data:
    name: ai-sentinel-postgres-data
  pgadmin-data:
    name: ai-sentinel-pgadmin-data
  huggingface-cache:
    name: ai-sentinel-huggingface-cache
  infisical-db-data:
    name: ai-sentinel-infisical-db-data
  infisical-redis-data:
    name: ai-sentinel-infisical-redis-data

networks:
  ai-sentinel-network:
    name: ai-sentinel-network
    driver: bridge

