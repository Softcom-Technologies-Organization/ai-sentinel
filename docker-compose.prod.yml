# Docker Compose for production - uses pre-built images from GitHub Container Registry
# Usage (full stack):  docker-compose -f docker-compose.prod.yml up
# Usage (secrets only): docker-compose -f docker-compose.prod.yml up secrets-bootstrap

services:
  # ============================================================================
  # BOOTSTRAP SECRETS (one-shot)
  # Creates ./secrets and generates the secrets required for Infisical on first startup
  # - infisical_encryption_key.txt (32 hex)
  # - infisical_auth_secret.txt (base64 44)
  # - infisical_db_password.txt (24 alphanum)
  # And creates placeholder files if missing:
  # - infisical_prod_client_id.txt
  # - infisical_prod_client_secret.txt
  # - infisical_project_id.txt
  # ============================================================================
  secrets-bootstrap:
    image: alpine:3.20
    container_name: ai-sentinel-secrets-bootstrap
    restart: "no"
    command: >
      sh -c '
        set -eu;
        
        echo "[secrets-bootstrap] Starting secrets initialization...";
        echo "[secrets-bootstrap] Creating /secrets directory...";
        mkdir -p /secrets || { echo "[ERROR] Failed to create /secrets directory"; exit 1; };
        
        # Verify directory is writable
        if [ ! -w /secrets ]; then
          echo "[ERROR] /secrets directory is not writable!";
          echo "[ERROR] Make sure Docker has permissions to write to the mounted volume.";
          exit 1;
        fi;
        
        echo "[secrets-bootstrap] Directory /secrets is ready and writable.";

        # Quick exit if required secrets already exist and look valid
        if [ -f /secrets/infisical_encryption_key.txt ] \
          && [ "$(wc -c < /secrets/infisical_encryption_key.txt 2>/dev/null || echo 0)" -eq 32 ] \
          && [ -f /secrets/infisical_auth_secret.txt ] \
          && [ "$(wc -c < /secrets/infisical_auth_secret.txt 2>/dev/null || echo 0)" -ge 44 ] \
          && [ -s /secrets/infisical_db_password.txt ]; then
          echo "[secrets-bootstrap] Core secrets already initialized and valid.";
          
          # Still create placeholder files if they do not exist
          [ -f /secrets/infisical_prod_client_id.txt ] || { echo "[secrets-bootstrap] Creating placeholder: infisical_prod_client_id.txt"; touch /secrets/infisical_prod_client_id.txt; };
          [ -f /secrets/infisical_prod_client_secret.txt ] || { echo "[secrets-bootstrap] Creating placeholder: infisical_prod_client_secret.txt"; touch /secrets/infisical_prod_client_secret.txt; };
          [ -f /secrets/infisical_project_id.txt ] || { echo "[secrets-bootstrap] Creating placeholder: infisical_project_id.txt"; touch /secrets/infisical_project_id.txt; };
          
          echo "[secrets-bootstrap] All done - secrets are ready!";
          exit 0;
        fi;

        echo "[secrets-bootstrap] Generating Infisical internal secrets...";

        # Infisical internal secrets
        if [ ! -f /secrets/infisical_encryption_key.txt ] \
          || [ "$(wc -c < /secrets/infisical_encryption_key.txt 2>/dev/null || echo 0)" -ne 32 ]; then
          echo "[secrets-bootstrap] Generating infisical_encryption_key.txt (32 hex chars)...";
          od -An -tx1 -N16 /dev/urandom | tr -d " \n" > /secrets/infisical_encryption_key.txt || { echo "[ERROR] Failed to create encryption key"; exit 1; };
          echo "[secrets-bootstrap] ✓ infisical_encryption_key.txt created";
        else
          echo "[secrets-bootstrap] ✓ infisical_encryption_key.txt already exists and is valid";
        fi;

        if [ ! -f /secrets/infisical_auth_secret.txt ] \
          || [ "$(wc -c < /secrets/infisical_auth_secret.txt 2>/dev/null || echo 0)" -lt 44 ]; then
          echo "[secrets-bootstrap] Generating infisical_auth_secret.txt (base64 44 chars)...";
          head -c 32 /dev/urandom | base64 | tr -d "\n\r" > /secrets/infisical_auth_secret.txt || { echo "[ERROR] Failed to create auth secret"; exit 1; };
          echo "[secrets-bootstrap] ✓ infisical_auth_secret.txt created";
        else
          echo "[secrets-bootstrap] ✓ infisical_auth_secret.txt already exists and is valid";
        fi;

        if [ ! -s /secrets/infisical_db_password.txt ]; then
          echo "[secrets-bootstrap] Generating infisical_db_password.txt (24 alphanumeric)...";
          head -c 256 /dev/urandom | tr -dc "A-Za-z0-9" | head -c 24 > /secrets/infisical_db_password.txt || { echo "[ERROR] Failed to create DB password"; exit 1; };
          echo "[secrets-bootstrap] ✓ infisical_db_password.txt created";
        else
          echo "[secrets-bootstrap] ✓ infisical_db_password.txt already exists";
        fi;

        echo "[secrets-bootstrap] Creating placeholder files for manual configuration...";
        # Placeholders to link other services later (must be filled manually)
        touch /secrets/infisical_prod_client_id.txt || { echo "[ERROR] Failed to create infisical_prod_client_id.txt"; exit 1; };
        echo "[secrets-bootstrap] ✓ infisical_prod_client_id.txt created (EMPTY - fill manually)";
        
        touch /secrets/infisical_prod_client_secret.txt || { echo "[ERROR] Failed to create infisical_prod_client_secret.txt"; exit 1; };
        echo "[secrets-bootstrap] ✓ infisical_prod_client_secret.txt created (EMPTY - fill manually)";
        
        touch /secrets/infisical_project_id.txt || { echo "[ERROR] Failed to create infisical_project_id.txt"; exit 1; };
        echo "[secrets-bootstrap] ✓ infisical_project_id.txt created (EMPTY - fill manually)";
        
        echo "";
        echo "[secrets-bootstrap] ========================================";
        echo "[secrets-bootstrap] SUCCESS! All secret files created.";
        echo "[secrets-bootstrap] ========================================";
        echo "[secrets-bootstrap] ";
        echo "[secrets-bootstrap] NEXT STEPS:";
        echo "[secrets-bootstrap] 1. Fill in these files manually with values from Infisical UI:";
        echo "[secrets-bootstrap]    - infisical_prod_client_id.txt";
        echo "[secrets-bootstrap]    - infisical_prod_client_secret.txt";
        echo "[secrets-bootstrap]    - infisical_project_id.txt";
        echo "[secrets-bootstrap] 2. See secrets/README.md for detailed instructions";
        echo "[secrets-bootstrap] ";
      '
    volumes:
      - ./secrets:/secrets
    networks:
      - ai-sentinel-network
  # ============================================================================
  # DATABASE SERVICE
  # ============================================================================
  postgres:
    image: postgres:18
    container_name: ai-sentinel-db-prod
    restart: unless-stopped
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: ai-sentinel
    volumes:
      - postgres-data:/var/lib/postgresql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d ai-sentinel"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - ai-sentinel-network

  # ============================================================================
  # PII DETECTOR SERVICE (Python/gRPC) - PRE-BUILT IMAGE
  # ============================================================================
  pii-detector:
    image: ghcr.io/softcom-technologies-organization/ai-sentinel-pii-detector:0.0.1
    container_name: pii-detector-service
    restart: unless-stopped
    ports:
      - "50051:50051"
    environment:
      # Infisical Configuration - secrets will be read from /secrets/
      INFISICAL_CLIENT_ID_FILE: /secrets/infisical_prod_client_id.txt
      INFISICAL_CLIENT_SECRET_FILE: /secrets/infisical_prod_client_secret.txt
      INFISICAL_PROJECT_ID_FILE: /secrets/infisical_project_id.txt
      INFISICAL_API_URL: http://infisical:8080
      INFISICAL_ENV: prod

      # Static non-sensitive configuration
      HF_HOME: /app/.cache/huggingface
      TRANSFORMERS_CACHE: /app/.cache/huggingface
    volumes:
      - huggingface-cache:/app/.cache/huggingface
      - ./secrets:/secrets:ro
    depends_on:
      secrets-bootstrap:
        condition: service_completed_successfully
      infisical:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "python -c 'import grpc; channel = grpc.insecure_channel(\"localhost:50051\"); channel.close()'"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    networks:
      - ai-sentinel-network

  # ============================================================================
  # PII REPORTING API (Spring Boot) - PRE-BUILT IMAGE
  # ============================================================================
  pii-reporting-api:
    image: ghcr.io/softcom-technologies-organization/ai-sentinel-reporting-api:0.0.1
    container_name: pii-reporting-api
    restart: unless-stopped
    ports:
      - "8080:8080"
      - "8090:8090"  # Armeria internal services (health, metrics, docs)
    environment:
      # Infisical Configuration - secrets will be read from /secrets/
      INFISICAL_CLIENT_ID_FILE: /secrets/infisical_prod_client_id.txt
      INFISICAL_CLIENT_SECRET_FILE: /secrets/infisical_prod_client_secret.txt
      INFISICAL_PROJECT_ID_FILE: /secrets/infisical_project_id.txt
      INFISICAL_API_URL: http://infisical:8080
      INFISICAL_ENV: prod

      # Static non-sensitive configuration
      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: ai-sentinel
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/ai-sentinel
      SERVER_PORT: 8080
      PII_DETECTOR_CLIENT: armeria
      PII_DETECTOR_HOST: pii-detector
      PII_DETECTOR_PORT: 50051
      
      # Non-sensitive Confluence configuration (optional with defaults)
      CONFLUENCE_ENABLE_PROXY: ${CONFLUENCE_ENABLE_PROXY:-false}
      CONFLUENCE_PROXY_HOST: ${CONFLUENCE_PROXY_HOST:-}
      CONFLUENCE_PROXY_PORT: ${CONFLUENCE_PROXY_PORT:-8080}
      CONFLUENCE_PROXY_USERNAME: ${CONFLUENCE_PROXY_USERNAME:-}
      CONFLUENCE_CACHE_REFRESH_INTERVAL: ${CONFLUENCE_CACHE_REFRESH_INTERVAL:-300000}
      CONFLUENCE_CACHE_INITIAL_DELAY: ${CONFLUENCE_CACHE_INITIAL_DELAY:-5000}
      CONFLUENCE_POLLING_INTERVAL: ${CONFLUENCE_POLLING_INTERVAL:-60000}
      SENTINELLE_ENCRYPTION_KEY: ${SENTINELLE_ENCRYPTION_KEY}
    volumes:
      - ./secrets:/secrets:ro
    depends_on:
      postgres:
        condition: service_healthy
      pii-detector:
        condition: service_started
      infisical:
        condition: service_healthy
      secrets-bootstrap:
        condition: service_completed_successfully
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/sentinelle/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    networks:
      - ai-sentinel-network

  # ============================================================================
  # PII REPORTING UI (Angular + Nginx) - PRE-BUILT IMAGE
  # ============================================================================
  pii-reporting-ui:
    image: ghcr.io/softcom-technologies-organization/ai-sentinel-reporting-ui:0.0.1
    container_name: pii-reporting-ui
    restart: unless-stopped
    ports:
      - "4200:80"
    depends_on:
      pii-reporting-api:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:80 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - ai-sentinel-network

  # ============================================================================
  # INFISICAL (Secrets Manager)
  # ============================================================================
  infisical-db:
    image: postgres:18-alpine
    container_name: infisical-db-prod
    restart: unless-stopped
    environment:
      POSTGRES_USER: infisical
      POSTGRES_PASSWORD_FILE: /secrets/infisical_db_password.txt
      POSTGRES_DB: infisical
    volumes:
      - infisical-db-data:/var/lib/postgresql/data
      - ./secrets:/secrets:ro
    networks:
      - ai-sentinel-network

  infisical-redis:
    image: redis:7-alpine
    container_name: infisical-redis-prod
    restart: unless-stopped
    command: ["redis-server", "--appendonly", "yes"]
    volumes:
      - infisical-redis-data:/data
    networks:
      - ai-sentinel-network

  mailhog:
    image: mailhog/mailhog:latest
    container_name: mailhog
    restart: unless-stopped
    ports:
      # SMTP server is only needed inside Docker network; not exposed to host for security
      # - "127.0.0.1:1025:1025"  # Uncomment if you need to test SMTP from the host
      - "127.0.0.1:8025:8025"  # Web UI (localhost only)
    networks:
      - ai-sentinel-network

  infisical:
    image: infisical/infisical:latest-postgres
    container_name: infisical-prod
    restart: unless-stopped
    ports:
      - "8082:8080"  # Expose Infisical UI on localhost:8082
    environment:
      NODE_ENV: production
      REDIS_URL: redis://infisical-redis:6379
      SITE_URL: ${INFISICAL_SITE_URL:-http://localhost:8082}
      # SMTP Configuration (MailHog for local development, configure real SMTP in production)
      SMTP_HOST: ${SMTP_HOST:-mailhog}
      SMTP_PORT: ${SMTP_PORT:-1025}
      SMTP_SECURE: ${SMTP_SECURE:-false}
      SMTP_FROM_ADDRESS: ${SMTP_FROM_ADDRESS:-noreply@ai-sentinel.local}
      SMTP_FROM_NAME: ${SMTP_FROM_NAME:-AI Sentinel Infisical}
      SMTP_USERNAME: ${SMTP_USERNAME:-}
      SMTP_PASSWORD: ${SMTP_PASSWORD:-}
      SMTP_TLS_ENABLED: ${SMTP_TLS_ENABLED:-false}
      SMTP_STARTTLS_ENABLED: ${SMTP_STARTTLS_ENABLED:-false}
      SMTP_IGNORE_TLS: ${SMTP_IGNORE_TLS:-true}
    command: >
      sh -c '
        export ENCRYPTION_KEY=$$(cat /secrets/infisical_encryption_key.txt) &&
        export AUTH_SECRET=$$(cat /secrets/infisical_auth_secret.txt) &&
        export DB_CONNECTION_URI="postgres://infisical:$$(cat /secrets/infisical_db_password.txt)@infisical-db:5432/infisical" &&
        exec /usr/local/bin/docker-entrypoint.sh ./standalone-entrypoint.sh
      '
    depends_on:
      secrets-bootstrap:
        condition: service_completed_successfully
      infisical-db:
        condition: service_started
      infisical-redis:
        condition: service_started
      mailhog:
        condition: service_started
    volumes:
      - ./secrets:/secrets:ro
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/api/status"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s
    networks:
      - ai-sentinel-network

  # ============================================================================
  # PGADMIN (Optional - Database Management UI)
  # ============================================================================
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: pgadmin-sentinel
    restart: unless-stopped
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@pgadmin.com
      PGADMIN_DEFAULT_PASSWORD: admin
      PGADMIN_CONFIG_SERVER_MODE: 'False'
      PGADMIN_CONFIG_MASTER_PASSWORD_REQUIRED: 'False'
    ports:
      - "5050:80"
    volumes:
      - pgadmin-data:/var/lib/pgadmin
    depends_on:
      - postgres
    networks:
      - ai-sentinel-network
    profiles:
      - admin  # Optional: start only with --profile admin

volumes:
  postgres-data:
    name: ai-sentinel-postgres-data
  pgadmin-data:
    name: ai-sentinel-pgadmin-data
  huggingface-cache:
    name: ai-sentinel-huggingface-cache
  infisical-db-data:
    name: ai-sentinel-infisical-db-data-prod
  infisical-redis-data:
    name: ai-sentinel-infisical-redis-data-prod

networks:
  ai-sentinel-network:
    name: ai-sentinel-network
    driver: bridge

# Note: We use a bind volume ./secrets to simplify automatic bootstrap.
# For increased security in production, replace it with Docker secrets managed by your orchestrator.
