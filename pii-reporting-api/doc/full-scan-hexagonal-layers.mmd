sequenceDiagram
    autonumber
    
    participant UI as ğŸŒ UI (Angular)<br/>EXTERNAL
    
    participant Controller as ğŸ“¥ ScanController<br/>ADAPTER IN<br/>Infrastructure
    participant ConfAdapter as ğŸ“¤ ConfluenceHttpClientAdapter<br/>ADAPTER OUT<br/>Infrastructure
    participant DBAdapter as ğŸ“¤ JpaScanResultRepository<br/>ADAPTER OUT<br/>Infrastructure
    
    participant UseCase as âš™ï¸ StreamConfluenceScanUseCase<br/>PORT IN + USE CASE<br/>Application
    participant ConfluenceAcc as ğŸ”§ ConfluenceAccessor<br/>SERVICE<br/>Application
    participant ConfPort as ğŸ”Œ ConfluenceClient<br/>PORT OUT (interface)<br/>Application
    participant PiiPort as ğŸ”Œ PiiDetectorClient<br/>PORT OUT (interface)<br/>Application
    participant ScanOrch as ğŸ”§ ScanOrchestrator<br/>SERVICE<br/>Application
    
    participant Domain as ğŸ“¦ ContentPiiDetection<br/>DOMAIN OBJECT<br/>Domain
    participant Event as ğŸ“¦ SpaceScanCompleted<br/>DOMAIN EVENT<br/>Domain
    
    participant Confluence as ğŸŒ Confluence API<br/>EXTERNAL
    participant PiiService as ğŸŒ pii-detector-service<br/>EXTERNAL (gRPC)
    participant DB as ğŸ—„ï¸ PostgreSQL<br/>EXTERNAL

    Note over UI,DB: Scan Nominal - Nouveau scan global de tous les espaces

    UI->>Controller: GET /api/v1/stream/confluence/spaces/events<br/>(SSE WebFlux)
    activate Controller
    Note right of Controller: Line 77: streamAllSpacesScan()
    
    Controller->>UseCase: streamAllSpaces()
    activate UseCase
    Note right of UseCase: Interface Port IN + implÃ©mentation
    
    UseCase->>UseCase: GÃ©nÃ¨re scanId (UUID)
    UseCase-->>Controller: Flux: event "MULTI_START"
    Controller-->>UI: SSE: MULTI_START (scanId)
    
    UseCase->>ConfluenceAcc: getAllSpaces()
    activate ConfluenceAcc
    ConfluenceAcc->>ConfPort: getAllSpaces()
    Note right of ConfPort: Interface Port OUT
    ConfPort->>ConfAdapter: [implÃ©mentation]
    activate ConfAdapter
    ConfAdapter->>Confluence: GET /wiki/api/v2/spaces
    Confluence-->>ConfAdapter: List<Space>
    deactivate ConfAdapter
    ConfAdapter-->>ConfluenceAcc: List<ConfluenceSpace>
    deactivate ConfluenceAcc
    
    loop Pour chaque espace (nominal)
        UseCase->>ConfluenceAcc: getAllPagesInSpace(spaceKey)
        ConfluenceAcc->>ConfAdapter: via ConfluenceClient
        ConfAdapter->>Confluence: GET /wiki/api/v2/spaces/{id}/pages
        Confluence-->>ConfAdapter: List<Page>
        ConfAdapter-->>UseCase: List<ConfluencePage>
        
        UseCase-->>Controller: event "start" (pagesTotal)
        Controller-->>UI: SSE: start
        
        loop Pour chaque page (nominal)
            UseCase->>ScanOrch: processPage(page)
            activate ScanOrch
            
            ScanOrch->>ConfAdapter: getPageContent(pageId)
            ConfAdapter->>Confluence: GET /wiki/api/v2/pages/{id}
            Confluence-->>ConfAdapter: Page content
            ConfAdapter-->>ScanOrch: String content
            
            ScanOrch->>PiiPort: analyzeContent(content)
            Note right of PiiPort: Interface Port OUT
            PiiPort->>PiiService: gRPC DetectPii(request)
            PiiService-->>PiiPort: PiiDetectionResponse
            PiiPort-->>ScanOrch: ContentPiiDetection
            
            ScanOrch->>Domain: new ContentPiiDetection(detections)
            Note right of Domain: Objet du domaine mÃ©tier
            
            ScanOrch-->>UseCase: ContentPiiDetection
            deactivate ScanOrch
            
            UseCase->>DBAdapter: persist(ScanEvent)
            DBAdapter->>DB: INSERT INTO scan_events
            DB-->>DBAdapter: OK
            
            UseCase-->>Controller: event "item" (dÃ©tections)
            Controller-->>UI: SSE: item
        end
        
        UseCase-->>Controller: event "complete" (space terminÃ©)
        Controller-->>UI: SSE: complete
        
        UseCase->>Event: new SpaceScanCompleted(scanId, spaceKey)
        Note right of Event: Domain Event publiÃ©
        UseCase->>UseCase: publish(SpaceScanCompleted)
        Note over Event: DÃ©clenche export Excel (async)
    end
    
    UseCase-->>Controller: event "MULTI_COMPLETE"
    deactivate UseCase
    Controller-->>UI: SSE: MULTI_COMPLETE
    deactivate Controller

    Note over UI,DB: Architecture Hexagonale :<br/>- Domain : logique mÃ©tier pure, indÃ©pendante<br/>- Application : cas d'usage, orchestration via ports<br/>- Infrastructure : adaptateurs vers systÃ¨mes externes
