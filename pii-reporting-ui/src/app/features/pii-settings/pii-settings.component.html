<p-toast></p-toast>

<div class="settings-page">
  <div class="settings-header">
    <h2>
      <i class="pi pi-cog"></i>
      {{ 'settings.title' | transloco }}
    </h2>
    <div class="spacer"></div>
    <p-button
      type="button"
      icon="pi pi-arrow-left"
      [text]="true"
      [label]="'settings.back' | transloco"
      routerLink="/">
    </p-button>
  </div>

  @if (loading()) {
    <div class="loading-container">
      <p-progressSpinner></p-progressSpinner>
    </div>
  } @else {
    <div class="settings-content">
      <!-- DETECTOR LEVEL CONFIGURATION -->
      <div class="settings-card">
        <form [formGroup]="configForm">
          <h3 class="card-title">
            <i class="pi pi-sliders-h"></i>
            {{ 'settings.detectorConfig.title' | transloco }}
          </h3>

          <!-- Detectors Section -->
          <div class="form-section">
            <h4 class="section-subtitle">{{ 'settings.sections.detectors' | transloco }}</h4>

            <div class="form-field">
              <label>
                <span class="field-label">{{ 'settings.detectors.gliner.label' | transloco }}</span>
                <p-toggleSwitch
                  formControlName="glinerEnabled"
                  [ariaLabel]="'settings.detectors.gliner.label' | transloco">
                </p-toggleSwitch>
              </label>
              <p class="field-description">{{ 'settings.detectors.gliner.description' | transloco }}</p>
            </div>

            <div class="form-field">
              <label>
                <span class="field-label">{{ 'settings.detectors.presidio.label' | transloco }}</span>
                <p-toggleSwitch
                  formControlName="presidioEnabled"
                  [ariaLabel]="'settings.detectors.presidio.label' | transloco">
                </p-toggleSwitch>
              </label>
              <p class="field-description">{{ 'settings.detectors.presidio.description' | transloco }}</p>
            </div>

            <div class="form-field">
              <label>
                <span class="field-label">{{ 'settings.detectors.regex.label' | transloco }}</span>
                <p-toggleSwitch
                  formControlName="regexEnabled"
                  [ariaLabel]="'settings.detectors.regex.label' | transloco">
                </p-toggleSwitch>
              </label>
              <p class="field-description">{{ 'settings.detectors.regex.description' | transloco }}</p>
            </div>

            @if (atLeastOneDetectorError) {
              <div class="validation-error">
                <i class="pi pi-exclamation-circle"></i>
                {{ 'settings.validation.atLeastOneDetector' | transloco }}
              </div>
            }
          </div>

          <!-- Threshold Section -->
          <div class="form-section">
            <h4 class="section-subtitle">{{ 'settings.sections.threshold' | transloco }}</h4>

            <div class="form-field threshold-field">
              <label>
                <span class="field-label">{{ 'settings.threshold.label' | transloco }}</span>
              </label>
              <p class="field-description">{{ 'settings.threshold.description' | transloco }}</p>

              <div class="threshold-input-group">
                <p-inputNumber
                  formControlName="defaultThreshold"
                  [min]="0"
                  [max]="1"
                  [step]="0.05"
                  [minFractionDigits]="2"
                  [maxFractionDigits]="2"
                  [showButtons]="true"
                  buttonLayout="horizontal"
                  incrementButtonIcon="pi pi-plus"
                  decrementButtonIcon="pi pi-minus">
                </p-inputNumber>
              </div>
            </div>
          </div>

          <!-- Detector Config Action Buttons -->
          <div class="section-actions">
            <p-button
              type="button"
              [label]="'settings.detectorConfig.actions.save' | transloco"
              icon="pi pi-check"
              [disabled]="saving() || !hasDetectorChanges"
              [loading]="saving()"
              (click)="onSaveDetectorConfig()"
              styleClass="p-button-success p-button-sm">
            </p-button>

            <p-button
              type="button"
              [label]="'settings.detectorConfig.actions.reset' | transloco"
              icon="pi pi-refresh"
              [disabled]="!hasDetectorChanges"
              (click)="onResetDetectorConfig()"
              styleClass="p-button-sm">
            </p-button>
          </div>

          <!-- Info Card -->
          @if (currentConfig()) {
            <div class="info-card">
              <div class="info-title">{{ 'settings.info.title' | transloco }}</div>
              <div class="info-content">
                <div class="info-item">
                  <strong>{{ 'settings.info.lastUpdated' | transloco }}</strong>
                  {{ currentConfig()!.updatedAt | date:'medium' }}
                </div>
                <div class="info-item">
                  <strong>{{ 'settings.info.updatedBy' | transloco }}</strong>
                  {{ currentConfig()!.updatedBy }}
                </div>
              </div>
            </div>
          }
        </form>
      </div>

      <!-- PII TYPE CONFIGURATIONS -->
      <div class="settings-card pii-types-card">
        <h3 class="card-title">
          <i class="pi pi-list"></i>
          {{ 'settings.piiTypes.title' | transloco }}
        </h3>

        <p class="card-description">
          {{ 'settings.piiTypes.description' | transloco }}
        </p>

        @if (hasUnsavedTypeChanges()) {
          <div class="unsaved-changes-banner">
            <i class="pi pi-info-circle"></i>
            {{ 'settings.piiTypes.unsavedChanges' | transloco: {count: modifiedTypesCount} }}
          </div>
        }

        <!-- Nested Accordions -->
        <p-accordion [multiple]="true" class="pii-types-accordion">
          @for (detectorGroup of groupedPiiTypes(); track detectorGroup.detector) {
            <p-accordionTab>
              <ng-template pTemplate="header">
                <div class="detector-header">
                  <i class="pi pi-shield"></i>
                  <span class="detector-name">
                    {{ 'settings.piiTypes.detectors.' + detectorGroup.detector.toLowerCase() | transloco }}
                  </span>
                  <span class="detector-count">
                    ({{ detectorGroup.categories.length }} {{ 'settings.piiTypes.categories' | transloco }})
                  </span>
                </div>
              </ng-template>

              <!-- Category Sub-Accordions -->
              <p-accordion [multiple]="true" class="category-accordion">
                @for (categoryGroup of detectorGroup.categories; track categoryGroup.category) {
                  <p-accordionTab>
                    <ng-template pTemplate="header">
                      <div class="category-header">
                        <i class="pi pi-folder-open"></i>
                        <span class="category-name">
                          {{ 'settings.piiTypes.categoryNames.' + categoryGroup.category | transloco }}
                        </span>
                        <span class="type-count">
                          ({{ categoryGroup.types.length }} {{ 'settings.piiTypes.types' | transloco }})
                        </span>
                      </div>
                    </ng-template>

                    <!-- PII Types List -->
                    <div class="pii-types-list">
                      @for (type of categoryGroup.types; track type.piiType) {
                        <div class="pii-type-item">
                          <div class="row align-items-center">
                            <div class="col-6 col-md-8">
                              <span class="type-name">
                                {{ 'settings.piiTypes.typeNames.' + type.piiType | transloco }}
                              </span>
                              @if (type.countryCode) {
                                <span class="type-country">
                                  ({{ type.countryCode }})
                                </span>
                              }
                            </div>
                            <div class="col-2 col-md-2 text-center">
                              <p-toggleSwitch
                                [(ngModel)]="type.enabled"
                                (ngModelChange)="onPiiTypeToggleChange(type, $event)"
                                [ariaLabel]="'settings.piiTypes.toggle' | transloco: {type: type.displayName}">
                              </p-toggleSwitch>
                            </div>
                            @if (type.enabled) {
                              <div class="col-4 col-md-2">
                                <div class="threshold-input-group">
                                  <p-inputNumber
                                    [(ngModel)]="type.threshold"
                                    (ngModelChange)="onPiiTypeThresholdChange(type, $event)"
                                    [min]="0"
                                    [max]="1"
                                    [step]="0.05"
                                    [minFractionDigits]="2"
                                    [maxFractionDigits]="2"
                                    [showButtons]="true"
                                    buttonLayout="horizontal"
                                    incrementButtonIcon="pi pi-plus"
                                    decrementButtonIcon="pi pi-minus">
                                  </p-inputNumber>
                                </div>
                              </div>
                            }
                          </div>
                          <div class="row">
                            <div class="col-12">
                              <p class="type-description">
                                {{ 'settings.piiTypes.typeDescriptions.' + type.piiType | transloco }}
                              </p>
                            </div>
                          </div>
                        </div>
                      }
                    </div>
                  </p-accordionTab>
                }
              </p-accordion>
            </p-accordionTab>
          }
        </p-accordion>

        <!-- PII Types Action Buttons -->
        <div class="section-actions">
          <p-button
            type="button"
            [label]="'settings.piiTypes.actions.saveAll' | transloco"
            icon="pi pi-check"
            [disabled]="saving() || !hasUnsavedTypeChanges()"
            [loading]="saving()"
            (click)="onSavePiiTypes()"
            styleClass="p-button-success p-button-sm">
          </p-button>

          <p-button
            type="button"
            [label]="'settings.piiTypes.actions.reset' | transloco"
            icon="pi pi-refresh"
            [disabled]="!hasUnsavedTypeChanges()"
            (click)="onResetPiiTypes()"
            styleClass="p-button-sm">
          </p-button>
        </div>
      </div>

      <!-- GLOBAL ACTION BUTTONS -->
      <div class="global-actions">
        <p-button
          type="button"
          [label]="'settings.actions.saveAll' | transloco"
          icon="pi pi-save"
          [disabled]="saving() || !hasUnsavedChanges"
          [loading]="saving()"
          (click)="onSaveAll()"
          styleClass="p-button-success">
        </p-button>

        <p-button
          type="button"
          [label]="'settings.actions.resetAll' | transloco"
          icon="pi pi-replay"
          [disabled]="!hasUnsavedChanges"
          (click)="onResetAll()">
        </p-button>

        <p-button
          type="button"
          [label]="'settings.actions.cancel' | transloco"
          icon="pi pi-times"
          (click)="onCancel()"
          styleClass="p-button-outlined">
        </p-button>
      </div>
    </div>
  }
</div>
