<div class="page p-3">
  <div class="header">
    <h2 class="m-0">Sentinel AI</h2>
    <div class="spacer"></div>
    <p-button type="button"
              icon="pi pi-play"
              styleClass="p-button-raised p-button-primary"
              (click)="startAll()"
              (keydown.enter)="startAll()"
              (keydown.space)="$event.preventDefault(); startAll()"
              [disabled]="!canStartScan()"
              pTooltip="Démarrer le scan global"
              tooltipPosition="bottom"
              ariaLabel="Démarrer le scan global">
    </p-button>
    <p-button type="button"
              icon="pi pi-pause"
              styleClass="p-button-outlined p-button-danger"
              (click)="stopCurrentScan()"
              (keydown.enter)="stopCurrentScan()"
              (keydown.space)="$event.preventDefault(); stopCurrentScan()"
              [disabled]="!isStreaming()"
              pTooltip="Interrompre le scan"
              tooltipPosition="bottom"
              ariaLabel="Interrompre le scan">
    </p-button>
    <p-button type="button"
              icon="pi pi-refresh"
              styleClass="p-button-warning"
              (click)="resumeLastScan()"
              (keydown.enter)="resumeLastScan()"
              (keydown.space)="$event.preventDefault(); resumeLastScan()"
              [disabled]="!canResumeScan()"
              pTooltip="Reprendre le dernier scan"
              tooltipPosition="bottom"
              ariaLabel="Reprendre le dernier scan">
    </p-button>
  </div>

  <!-- Phase 2: New spaces notification banner -->
  @if (hasNewSpaces()) {
    <div class="new-spaces-banner">
      <i class="pi pi-info-circle"></i>
      <span class="banner-message">
        {{ newSpacesCount() }} nouvel(aux) espace(s) Confluence disponible(s)
      </span>
      <button pButton type="button" class="p-button-raised p-button-sm"
              (click)="refreshSpaces()"
              (keydown.enter)="refreshSpaces()"
              (keydown.space)="$event.preventDefault(); refreshSpaces()">
        Rafraichir
      </button>
      <button pButton type="button" class="p-button-text p-button-sm" icon="pi pi-times"
              (click)="dismissNotification()"
              (keydown.enter)="dismissNotification()"
              (keydown.space)="$event.preventDefault(); dismissNotification()"
              aria-label="Fermer la notification">
      </button>
    </div>
  }

  <p-table
           [value]="filteredSpaces()"
           [paginator]="true"
           [rows]="10"
           [tableStyle]="{'min-width':'60rem'}"
           [rowsPerPageOptions]="[10, 20, 50]"
           [expandedRowKeys]="expandedRowKeys()" (onRowExpand)="onRowExpand($event)"
           (onRowCollapse)="onRowCollapse($event)"
           [attr.data-testid]="testIds.table">
    <ng-template pTemplate="header">
      <tr>
        <th id="col-toggle" style="width:3rem"></th>
        <th id="col-space" [attr.data-testid]="testIds.headers.space">Space</th>
        <th id="col-status" [attr.data-testid]="testIds.headers.status">Statut</th>
        <th id="col-progress" [attr.data-testid]="testIds.headers.progress">Progression</th>
        <th id="col-last-scan" [attr.data-testid]="testIds.headers.lastScan">Dernier scan</th>
        <th id="col-pii" [attr.data-testid]="testIds.headers.pii">PII</th>
        <th id="col-actions" [attr.data-testid]="testIds.headers.actions">Actions</th>
      </tr>
      <tr>
        <th id="col-toggle-value"></th>
        <th id="col-space-value">
          <input class="search-global" pInputText type="text" placeholder="Rechercher"
                 [ngModel]="globalFilter()"
                 (ngModelChange)="onGlobalChange($event)" aria-label="Rechercher globalement"/>
        </th>
        <th id="col-status-value">
          <p-select [options]="statusOptions"
                    optionLabel="label"
                    optionValue="value"
                    [ngModel]="statusFilter()"
                    (ngModelChange)="onFilter('status', $event)"
                    [showClear]="true"></p-select>
        </th>
        <th id="col-progress-value"></th>
        <th id="col-last-scan-value"></th>
        <th id="col-pii-value"></th>
        <th id="col-actions-value"></th>
      </tr>
    </ng-template>
    <ng-template pTemplate="body" let-space let-expanded="expanded">
      <tr class="row-click" tabindex="0" [attr.data-testid]="testIds.spaceRow">
        <td>
          <p-button type="button"
                    pRipple
                    [pRowToggler]="space"
                    [text]="true"
                    [rounded]="true"
                    [icon]="expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'"
                    [ariaLabel]="expanded ? 'Réduire' : 'Développer'">
          </p-button>
        </td>
        <td>
          <div class="d-flex align-items-center gap-2">
            <span class="fw-600" [attr.data-testid]="testIds.spaceName">{{ space.name }}</span>
          </div>
        </td>
        <td>
          <p-tag [value]="statusLabel(space.status)"
                 [severity]="statusSeverity(space.status)"></p-tag>
        </td>
        <td>
          <p-progressBar [value]="progressPercent(space.key)" [showValue]="true"
                         [style]="{'height':'0.75rem'}"></p-progressBar>
        </td>
        <td>{{ space.lastScanTs | date:'short' }}</td>
        <td>
          <p-badge [value]="space?.counts?.total ?? 0" size="large"
                   [attr.data-testid]="testIds.badges.total"></p-badge>
          <span class="ml-2">
                <p-badge [value]="space?.counts?.high ?? 0" severity="danger" class="ml-1"
                         size="large" [attr.data-testid]="testIds.badges.high"></p-badge>
                <p-badge [value]="space?.counts?.medium ?? 0" severity="warn" class="ml-1"
                         size="large" [attr.data-testid]="testIds.badges.medium"></p-badge>
                <p-badge [value]="space?.counts?.low ?? 0" severity="info" class="ml-1" size="large"
                         [attr.data-testid]="testIds.badges.low"></p-badge>
              </span>
        </td>
        <td>
          <span
            [pTooltip]="spacesDashboardUtils.hasConfluenceUrl(space) ? 'Ouvrir dans Confluence' : 'URL indisponible (non fournie par le backend)'"
            tooltipPosition="top">
            <p-button icon="pi pi-external-link"
                      styleClass="p-button-text"
                      [disabled]="!spacesDashboardUtils.hasConfluenceUrl(space)"
                      (click)="$event.stopPropagation(); openConfluence(space)"
                      (keydown.enter)="$event.stopPropagation(); openConfluence(space)"
                      (keydown.space)="$event.preventDefault(); $event.stopPropagation(); openConfluence(space)"
                      label="Confluence"></p-button>
          </span>
        </td>
      </tr>
    </ng-template>

    <ng-template pTemplate="loadingbody">
      @for (_ of skeletonRows; track $index) {
        <tr>
          <td>
            <p-skeleton width="1.5rem" height="1.5rem" shape="circle"></p-skeleton>
          </td>
          <td>
            <p-skeleton width="12rem"></p-skeleton>
          </td>
          <td>
            <p-skeleton width="6rem" height="1.5rem"></p-skeleton>
          </td>
          <td>
            <p-skeleton width="8rem" height="0.75rem"></p-skeleton>
          </td>
          <td>
            <p-skeleton width="9rem"></p-skeleton>
          </td>
          <td>
            <div style="display:flex; align-items:center; gap:0.5rem">
              <p-skeleton width="2rem" height="2rem"></p-skeleton>
              <p-skeleton width="2rem" height="2rem"></p-skeleton>
              <p-skeleton width="2rem" height="2rem"></p-skeleton>
            </div>
          </td>
          <td>
            <p-skeleton width="7rem"></p-skeleton>
          </td>
        </tr>
      }
    </ng-template>

    <ng-template pTemplate="rowexpansion" let-space>
      <tr>
        <td colspan="7">
          <div class="row-expansion">
            <div class="pii-scroll">
              <p-dataview [value]="itemsBySpace()[space.key] || []">
                <ng-template pTemplate="list" let-items>
                  <div class="grid grid-nogutter">
                    @for (it of items; track $index) {
                      <div class="col-12">
                        <app-pii-item-card [item]="it"
                                           [maskByDefault]="maskByDefault()"></app-pii-item-card>
                      </div>
                    }
                  </div>
                </ng-template>
                <ng-template pTemplate="empty">
                  <div class="text-muted">Aucun élément à afficher</div>
                </ng-template>
              </p-dataview>
            </div>
          </div>
        </td>
      </tr>
    </ng-template>
  </p-table>
</div>
