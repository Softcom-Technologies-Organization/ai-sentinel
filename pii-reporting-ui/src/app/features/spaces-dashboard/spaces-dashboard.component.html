<p-toast key="scan-errors" position="top-right" [baseZIndex]="5000"></p-toast>
<p-confirmDialog></p-confirmDialog>

<div class="page p-3">
  <div class="header">
    <h2 class="m-0">{{ 'dashboard.title' | transloco }}</h2>
    <div class="spacer"></div>
    <app-language-selector></app-language-selector>
  </div>

  <!-- Phase 2: New spaces notification banner -->
  <app-new-spaces-banner
    [hasNewSpaces]="hasNewSpaces()"
    [newSpacesCount]="newSpacesCount()"
    (refresh)="refreshSpaces()"
    (dismiss)="dismissNotification()">
  </app-new-spaces-banner>

  <p-table #dt [value]="sortedSpaces()"
           dataKey="key"
           sortField="name" [sortOrder]="1"
           [paginator]="true"
           [tableStyle]="{'min-width':'60rem'}"
           [loading]="isSpacesLoading()" [showLoader]="false"
           [rows]="20"
           [rowsPerPageOptions]="[10,20,50]"
           [expandedRowKeys]="expandedRowKeys()"
           (onRowExpand)="onRowExpand($event)"
           (onRowCollapse)="onRowCollapse($event)"
           (onSort)="onCustomSort($event)" [customSort]="true"
           [attr.data-testid]="testIds.table">
  <ng-template #header>
      <tr>
        <th id="col-toggle" style="width:3rem"></th>
        <th id="col-space" [attr.data-testid]="testIds.headers.space" pSortableColumn="name">
          {{ 'dashboard.table.headers.space' | transloco }}
          <p-sortIcon field="name"/>
        </th>
        <th id="col-status" [attr.data-testid]="testIds.headers.status">{{ 'dashboard.table.headers.status' | transloco }}</th>
        <th id="col-progress" [attr.data-testid]="testIds.headers.progress">{{ 'dashboard.table.headers.progress' | transloco }}</th>
        <th id="col-last-scan" [attr.data-testid]="testIds.headers.lastScan">{{ 'dashboard.table.headers.lastScan' | transloco }}</th>
        <th id="col-pii" [attr.data-testid]="testIds.headers.pii" pSortableColumn="piiCount">
          {{ 'dashboard.table.headers.pii' | transloco }}
          <p-sortIcon field="piiCount"/>
        </th>
        <th id="col-actions" [attr.data-testid]="testIds.headers.actions">{{ 'dashboard.table.headers.actions' | transloco }}</th>
      </tr>
      <tr>
        <th id="col-toggle-value"></th>
        <th id="col-space-value">
          <div class="space-filters">
            <div class="filter-item">
              <input
                class="search-global"
                pInputText
                type="text"
                [placeholder]="'common.search' | transloco"
                [ngModel]="globalFilter()"
                (ngModelChange)="onGlobalChange($event)"
                [attr.aria-label]="'common.searchGlobally' | transloco"
                [attr.data-testid]="'global-filter-input'"/>
            </div>
          </div>
        </th>
        <th id="col-status-value">
          <div class="space-filters">
            <div class="filter-item">
              <p-select
                [options]="statusOptions()"
                optionLabel="labelKey"
                optionValue="value"
                [ngModel]="statusFilter()"
                (ngModelChange)="onFilter('status', $event)"
                [showClear]="true"
                [attr.data-testid]="'status-filter-select'">
                <ng-template pTemplate="item" let-option>
                  {{ option.labelKey | transloco }}
                </ng-template>
                <ng-template pTemplate="selectedItem" let-option>
                  {{ option.labelKey | transloco }}
                </ng-template>
              </p-select>
            </div>
          </div>
        </th>
        <th id="col-progress-value"></th>
        <th id="col-last-scan-value"></th>
        <th id="col-pii-value"></th>
        <th id="col-actions-value" class="action-buttons-container">
          <p-button type="button"
                    icon="pi pi-play"
                    styleClass="p-button-raised p-button-info"
                    (click)="startAll()"
                    (keydown.enter)="startAll()"
                    (keydown.space)="$event.preventDefault(); startAll()"
                    [disabled]="!canStartScan()"
                    [pTooltip]="'dashboard.actions.startScan' | transloco"
                    tooltipPosition="bottom"
                    [ariaLabel]="'dashboard.actions.startScan' | transloco"
                    [attr.data-testid]="testIds.buttons.startScan">
          </p-button>
          <p-button type="button"
                    icon="pi pi-pause"
                    styleClass="p-button-raised pause-button"
                    (click)="stopCurrentScan()"
                    (keydown.enter)="stopCurrentScan()"
                    (keydown.space)="$event.preventDefault(); stopCurrentScan()"
                    [disabled]="!isStreaming()"
                    [pTooltip]="'dashboard.actions.pauseScan' | transloco"
                    tooltipPosition="bottom"
                    [ariaLabel]="'dashboard.actions.pauseScan' | transloco"
                    [attr.data-testid]="testIds.buttons.pauseScan">
          </p-button>
          <p-button type="button"
                    icon="pi pi-refresh"
                    styleClass="p-button-raised p-button-primary"
                    (click)="resumeLastScan()"
                    (keydown.enter)="resumeLastScan()"
                    (keydown.space)="$event.preventDefault(); resumeLastScan()"
                    [disabled]="!canResumeScan()"
                    [pTooltip]="'dashboard.actions.resumeScan' | transloco"
                    tooltipPosition="bottom"
                    [ariaLabel]="'dashboard.actions.resumeScan' | transloco"
                    [attr.data-testid]="testIds.buttons.resumeScan">
          </p-button>
        </th>
      </tr>
    </ng-template>
    <ng-template #body let-space let-expanded="expanded">
      <tr class="row-click" tabindex="0" [attr.data-testid]="testIds.spaceRow">
        <td>
          <p-button type="button"
                    pRipple
                    [pRowToggler]="space"
                    [text]="true"
                    [rounded]="true"
                    [icon]="expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'"
                    [ariaLabel]="(expanded ? 'dashboard.table.collapse' : 'dashboard.table.expand') | transloco"
                    [attr.data-testid]="testIds.expandButton">
          </p-button>
        </td>
        <td>
          <div class="d-flex align-items-center">
            <span class="fw-600" [attr.data-testid]="testIds.spaceName">{{ space.name }}</span>
            @if (hasSpaceBeenUpdated(space.key)) {
              <span class="space-updated-indicator"
                    [pTooltip]="getSpaceUpdateTooltip(space.key)"
                    tooltipPosition="right"
                    aria-hidden="true"></span>
            }
          </div>
        </td>
        <td>
          <p-tag [value]="statusLabel(space.status)"
                 [severity]="statusSeverity(space.status)"
                 [styleClass]="'status-tag ' + (spacesDashboardUtils.statusStyleClass(space.status) || '')"
                 [attr.data-testid]="testIds.spaceStatus"></p-tag>
        </td>
        <td>
          <app-scan-progress-bar [spaceKey]="space.key" [status]="space.status"></app-scan-progress-bar>
        </td>
        <td>{{ space.lastScanTs | date:'short' }}</td>
        <td>
          <p-badge [value]="space?.counts?.total ?? 0" size="large"
                   [attr.data-testid]="testIds.badges.total"></p-badge>
          <span>
                <p-badge [value]="space?.counts?.high ?? 0" severity="danger" class="ml-1"
                         size="large" [attr.data-testid]="testIds.badges.high"></p-badge>
                <p-badge [value]="space?.counts?.medium ?? 0" severity="warn" class="ml-1"
                         size="large" [attr.data-testid]="testIds.badges.medium"></p-badge>
                <p-badge [value]="space?.counts?.low ?? 0" severity="info" class="ml-1" size="large"
                         [attr.data-testid]="testIds.badges.low"></p-badge>
          </span>
        </td>
        <td>
          <span
            [pTooltip]="(spacesDashboardUtils.hasConfluenceUrl(space) ? 'dashboard.actions.openInConfluence' : 'dashboard.actions.confluenceUnavailable') | transloco"
            tooltipPosition="top">
            <p-button icon="pi pi-external-link"
                      styleClass="p-button-text"
                      [disabled]="!spacesDashboardUtils.hasConfluenceUrl(space)"
                      (click)="$event.stopPropagation(); openConfluence(space)"
                      (keydown.enter)="$event.stopPropagation(); openConfluence(space)"
                      (keydown.space)="$event.preventDefault(); $event.stopPropagation(); openConfluence(space)"
                      label="Confluence"></p-button>
          </span>
        </td>
      </tr>
    </ng-template>

    <ng-template pTemplate="loadingbody">
      @for (_ of skeletonRows; track $index) {
        <tr>
          <td>
            <p-skeleton width="1.5rem" height="1.5rem" shape="circle"></p-skeleton>
          </td>
          <td>
            <p-skeleton width="12rem"></p-skeleton>
          </td>
          <td>
            <p-skeleton width="6rem" height="1.5rem"></p-skeleton>
          </td>
          <td>
            <p-skeleton width="8rem" height="0.75rem"></p-skeleton>
          </td>
          <td>
            <p-skeleton width="9rem"></p-skeleton>
          </td>
          <td>
            <div style="display:flex; align-items:center; gap:0.5rem">
              <p-skeleton width="2rem" height="2rem"></p-skeleton>
              <p-skeleton width="2rem" height="2rem"></p-skeleton>
              <p-skeleton width="2rem" height="2rem"></p-skeleton>
            </div>
          </td>
          <td>
            <p-skeleton width="7rem"></p-skeleton>
          </td>
        </tr>
      }
    </ng-template>

    <ng-template #expandedrow let-space>
      <tr>
        <td colspan="7">
          <div class="row-expansion">
            <div class="pii-scroll">
              <p-dataview [value]="itemsBySpace()[space.key] || []">
                <ng-template #list let-items>
                  <div class="grid grid-nogutter">
                    @for (it of items; track $index) {
                      <div class="col-12">
                        <app-pii-item-card [item]="it"
                                           [maskByDefault]="maskByDefault()"></app-pii-item-card>
                      </div>
                    }
                  </div>
                </ng-template>
                <ng-template #empty>
                  <div class="text-muted">{{ 'dashboard.table.emptyMessage' | transloco }}</div>
                </ng-template>
              </p-dataview>
            </div>
          </div>
        </td>
      </tr>
    </ng-template>
  </p-table>
</div>
